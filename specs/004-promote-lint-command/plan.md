# Implementation Plan: Promote Lint Command to Top Level

**Branch**: `004-promote-lint-command` | **Date**: 2025-12-09 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-promote-lint-command/spec.md`

## Summary

This feature promotes the `lint` command from `kubectl odh doctor lint` to `kubectl odh lint` as a top-level command, removing the intermediary `doctor` parent command. The `--version` flag is renamed to `--target-version` for clarity. This is a breaking change that simplifies the CLI surface by providing direct access to the primary diagnostic command.

**Technical Approach**: Restructure command packages by moving `pkg/cmd/doctor/lint/` to `pkg/cmd/lint/`, remove `cmd/doctor/` directory, update flag names, and ensure all existing functionality is preserved with identical behavior.

## Technical Context

**Language/Version**: Go 1.25.5
**Primary Dependencies**:
- github.com/spf13/cobra (CLI framework)
- k8s.io/cli-runtime/pkg/genericiooptions (IOStreams)
- k8s.io/client-go/dynamic (Kubernetes client)

**Storage**: N/A (stateless CLI tool)
**Testing**:
- Unit tests: Go testing + Gomega assertions
- Integration tests: k3s-envtest for cluster simulation
- Fake client: k8s.io/client-go/dynamic/fake

**Target Platform**: kubectl plugin (Linux, macOS, Windows)
**Project Type**: Single CLI project
**Performance Goals**: Command execution time < 500ms for help/validation startup
**Constraints**:
- Zero breaking changes to lint validation logic
- Command execution time within 5% of current performance
- All existing flags/output formats must work identically

**Scale/Scope**:
- 1 command restructuring (doctor → lint promotion)
- 1 flag rename (--version → --target-version)
- ~10 files affected (command registration, help text, examples)
- No changes to check implementation logic

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase 0 Gates (Research)

✅ **kubectl Plugin Integration** (Principle I): Feature maintains kubectl plugin compliance. Command structure change (`kubectl odh lint`) follows kubectl patterns.

✅ **High-Level Resource Checks** (Principle IX): No changes to check targets. Checks continue operating on CRs (DataScienceCluster, Notebook, etc).

✅ **Cluster-Wide Diagnostic Scope** (Principle X): No changes to diagnostic scope. Lint command continues scanning all namespaces.

✅ **Lint Command Architecture** (Principle XI): Feature aligns with updated constitution v1.16.0. Promotes lint to top-level, uses `--target-version` flag as specified.

### Phase 1 Gates (Design)

⏳ **Extensible Command Structure** (Principle II): Command struct must implement Complete/Validate/Run/AddFlags methods. File must be named `lint.go`, not `options.go`. SharedOptions initialized internally.

⏳ **Consistent Output Formats** (Principle III): All output formats (table, JSON, YAML) must be preserved.

⏳ **Flexible Initialization Patterns** (Principle IV): Command must support both struct and functional options patterns.

⏳ **Package Granularity** (Principle: Development Standards): Package structure must follow `pkg/cmd/lint/` with focused, domain-specific organization.

### Phase 2 Gates (Implementation)

⏳ **Strict Error Handling** (Principle V): Errors wrapped with fmt.Errorf and %w, context propagation.

⏳ **Test-First Development** (Principle VI): Unit tests with Gomega, integration tests with k3s-envtest, testify/mock for mocking.

⏳ **Code Organization** (Development Standards): Follow standard Go CLI structure with cmd/ and pkg/ separation.

⏳ **Function Signatures** (Development Standards): Each parameter with own type declaration, multiline for many parameters.

⏳ **Commit Granularity** (Development Standards): One commit per task with T### ID in message.

⏳ **Message Constants** (Development Standards): User-facing messages as package-level constants.

⏳ **IOStreams Wrapper** (Development Standards): Use pkg/util/iostreams wrapper for output.

⏳ **make check** (Quality Gates): All code must pass linting, testing, and vulnerability scanning.

## Project Structure

### Documentation (this feature)

```text
specs/004-promote-lint-command/
├── plan.md              # This file
├── research.md          # Phase 0: Research findings
├── data-model.md        # Phase 1: Data model (minimal - mostly package structure)
├── quickstart.md        # Phase 1: Quick reference for command usage
├── contracts/           # Phase 1: Command API contract
│   └── command-api.md   # Lint command interface specification
├── checklists/
│   └── requirements.md  # Specification quality checklist
└── tasks.md             # Phase 2: Implementation tasks (generated by /speckit.tasks)
```

### Source Code (current state)

```text
cmd/
├── doctor/
│   ├── doctor.go              # Parent command (TO BE REMOVED)
│   └── lint.go                # Lint subcommand registration (TO BE MOVED)
└── root.go

pkg/cmd/
└── doctor/
    ├── lint/
    │   ├── lint.go            # Command implementation (TO BE MOVED)
    │   ├── lint_options.go    # Options struct (TO BE MOVED)
    │   └── lint_test.go       # Tests (TO BE MOVED)
    ├── shared_options.go      # Shared options (TO BE MOVED)
    └── shared_options_test.go # Tests (TO BE MOVED)

pkg/doctor/
├── check/                     # Check framework (TO BE MOVED to pkg/lint/)
├── version/                   # Version detection (TO BE MOVED to pkg/lint/)
└── checks/                    # Check implementations (TO BE MOVED to pkg/lint/)
```

### Source Code (target state)

```text
cmd/
├── lint.go                    # Top-level lint command registration (NEW)
└── root.go                    # Updated to add lint directly

pkg/cmd/
└── lint/
    ├── lint.go                # Command implementation (MOVED FROM pkg/cmd/doctor/lint/)
    ├── lint_options.go        # Options struct (MOVED)
    ├── lint_test.go           # Tests (MOVED)
    ├── shared_options.go      # Shared options (MOVED FROM pkg/cmd/doctor/)
    └── shared_options_test.go # Tests (MOVED)

pkg/lint/
├── check/                     # Check framework (MOVED FROM pkg/doctor/check/)
├── version/                   # Version detection (MOVED FROM pkg/doctor/version/)
└── checks/                    # Check implementations (MOVED FROM pkg/doctor/checks/)
```

**Structure Decision**: This is a single CLI project with cmd/ for command entry points and pkg/ for reusable packages. The restructuring moves from a nested `doctor/lint` hierarchy to a flat `lint` top-level structure, aligning with the simplified command access pattern.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | All constitution requirements satisfied |

**Rationale**: This refactoring simplifies the codebase by removing an unnecessary command layer. All constitutional requirements remain satisfied:
- Command interface (Complete/Validate/Run/AddFlags) preserved
- Package structure follows constitution (pkg/cmd/lint/, pkg/lint/)
- No changes to check implementation or testing patterns
- Flag renaming improves clarity without adding complexity

## Phase 0: Research

### Research Questions

Since this is a refactoring task with well-established patterns, research focuses on verification rather than exploration:

1. **Command Registration Pattern**: How does Cobra handle top-level vs nested command registration?
   - **Finding**: Top-level commands are added directly to root command via `root.AddCommand(cmd)`
   - **Impact**: Simple registration change in cmd/root.go

2. **Package Import Path Changes**: What files reference pkg/cmd/doctor or pkg/doctor?
   - **Finding**: Check imports, command initialization, test files
   - **Impact**: Systematic find-replace across codebase

3. **Flag Renaming Compatibility**: Can we cleanly remove --version without affecting other commands?
   - **Finding**: --version is flag for lint command only, not global
   - **Impact**: Safe to rename in lint command flag registration

4. **Help Text Updates**: Where are command descriptions and examples defined?
   - **Finding**: cmd/doctor/lint.go contains help text constants
   - **Impact**: Update all references from "kubectl odh doctor lint" to "kubectl odh lint"

**Research Output**: [research.md](./research.md) (generated in Phase 0)

## Phase 1: Design

### Data Model

**Package Structure**:
```go
// pkg/cmd/lint/lint.go
package lint

type Command struct {
    shared        *lint.SharedOptions
    targetVersion string  // Renamed from --version flag
    // ... other fields unchanged
}

// Constructor patterns (both supported per Principle IV)
func NewCommand(opts CommandOptions) *Command
func NewCommand(options ...CommandOption) *Command

// Interface methods (per Principle II)
func (c *Command) Complete() error
func (c *Command) Validate() error
func (c *Command) Run(ctx context.Context) error
func (c *Command) AddFlags(fs *pflag.FlagSet)
```

**Flag Changes**:
- Remove: `--version` flag
- Add: `--target-version` flag with identical functionality
- All other flags unchanged

### API Contracts

**Command Interface** (`contracts/command-api.md`):
- Input: CLI flags (--target-version, --output, --checks, etc.)
- Output: Validation results (table/JSON/YAML format)
- Behavior: Identical to current kubectl odh doctor lint

**Package Exports**:
- `pkg/cmd/lint.NewCommand()` - Primary entry point
- `pkg/cmd/lint.Command` - Command struct
- `pkg/cmd/lint.SharedOptions` - Shared configuration

### Quickstart

```bash
# Validate current cluster state
kubectl odh lint

# Assess upgrade readiness
kubectl odh lint --target-version 3.0

# JSON output
kubectl odh lint -o json

# Run specific checks
kubectl odh lint --checks "components/*"
```

See [quickstart.md](./quickstart.md) for complete reference.

## Migration Path

### For Users

**Before (deprecated)**:
```bash
kubectl odh doctor lint
kubectl odh doctor lint --version 3.0
```

**After (required)**:
```bash
kubectl odh lint
kubectl odh lint --target-version 3.0
```

### For Developers

**Import path changes**:
```go
// Before
import "github.com/lburgazzoli/odh-cli/pkg/cmd/doctor/lint"
import "github.com/lburgazzoli/odh-cli/pkg/doctor/check"

// After
import "github.com/lburgazzoli/odh-cli/pkg/cmd/lint"
import "github.com/lburgazzoli/odh-cli/pkg/lint/check"
```

## Implementation Strategy

### Step 1: Package Restructuring
1. Create new package structure under pkg/cmd/lint/
2. Create new package structure under pkg/lint/
3. Move files preserving git history
4. Update package declarations
5. Update import paths across codebase

### Step 2: Command Registration
1. Create cmd/lint.go for top-level registration
2. Update cmd/root.go to add lint command directly
3. Remove cmd/doctor/ directory entirely
4. Update tests

### Step 3: Flag Renaming
1. Update AddFlags() to register --target-version
2. Remove --version flag registration
3. Update help text and examples
4. Update tests to use new flag name

### Step 4: Validation
1. Run make check (lint, test, vulncheck)
2. Verify all existing tests pass
3. Verify command behavior unchanged
4. Verify help text correctness

## Testing Strategy

### Unit Tests
- Command initialization with new package path
- Flag parsing with --target-version
- Flag validation (invalid version formats)
- Help text rendering
- Error messages for removed --version flag

### Integration Tests
- Full command execution: `kubectl odh lint`
- Upgrade mode: `kubectl odh lint --target-version X.Y`
- All output formats (table, JSON, YAML)
- All existing flag combinations
- Verify removed command returns error

### Regression Tests
- Existing lint functionality unchanged
- Check execution logic unchanged
- Output format consistency
- Exit codes unchanged

## Rollout Plan

1. **Development**: Implement on feature branch 004-promote-lint-command
2. **Testing**: Run full test suite + manual verification
3. **Documentation**: Update README, examples, help text
4. **Release**: Merge to main as breaking change
5. **Communication**: Announce breaking change with migration guide

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| Users' scripts break | High | Clear migration documentation, release notes |
| Import path confusion | Medium | Automated search/replace, clear commit messages |
| Missed references to doctor command | Medium | Comprehensive grep for "doctor" string |
| Performance regression | Low | Benchmark comparison, same execution path |

## Success Metrics

- ✅ All existing tests pass with new structure
- ✅ `make check` passes (lint, test, vulncheck)
- ✅ Command execution time within 5% of baseline
- ✅ Zero changes to lint validation logic
- ✅ Help text accurately reflects new structure
- ✅ Old command paths return clear errors

## Next Steps

1. Run `/speckit.tasks` to generate actionable task list
2. Execute tasks sequentially with T### commits
3. Run `make check` after each task
4. Create PR when all tasks complete
